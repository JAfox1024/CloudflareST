name: CI

on:
  schedule:
    - cron: '* */4 * * *'  # 每四小时运行一次
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download IP list
        run: |
          Remove-Item -Force -ErrorAction SilentlyContinue ip.txt
          $ipV4 = Invoke-WebRequest -Uri "https://www.cloudflare-cn.com/ips-v4/" -UseBasicParsing
          $ipV6 = Invoke-WebRequest -Uri "https://www.cloudflare.com/ips-v6/" -UseBasicParsing
          $ipV4.Content + "`n" + $ipV6.Content | Out-File -FilePath ip.txt -Encoding utf8
        shell: pwsh

      - name: Make script executable and install dependencies
        run: |
          # Windows 不需要设置可执行权限，但可以确保文件存在
          if (-Not (Test-Path CloudflareST)) {
            Write-Host "CloudflareST not found!"
            exit 1
          }
          pip install pandas
        shell: pwsh

      - name: Run TLS scan
        run: |
          .\CloudflareST.exe -tp 443 -n 1000
          python convert_csv_to_tls.py
        shell: pwsh

      - name: Run notls scan
        run: |
          .\CloudflareST.exe -tp 80 -n 1000
          python convert_csv_to_tls.py notls
        shell: pwsh

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          if (git diff --quiet *.txt) {
            Write-Host "No changes to commit."
          } else {
            git add *.txt
            git commit -m "Update IP list"
            git push
          }
        shell: pwsh
